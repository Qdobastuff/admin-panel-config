<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Stores - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #1e3c72;
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .section h2 {
            color: #1e3c72;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #2a5298;
        }
        
        .instructions {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2a5298;
        }
        
        .instructions h3 {
            color: #1e3c72;
            margin-bottom: 12px;
        }
        
        .instructions p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .instructions code {
            background: #e0f2fe;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #0369a1;
        }
        
        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(30, 60, 114, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .success {
            background: #10b981;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }
        
        .success.show {
            display: block;
        }
        
        .error {
            background: #ef4444;
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .preview {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .progress {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            margin: 16px 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß All Stores Admin Panel</h1>
            <p>Upload last year's sales data for all 28 stores</p>
        </div>
        
        <!-- CSV Upload Section -->
        <div class="section">
            <h2>üìä Upload Complete Year Sales Data</h2>
            <div class="instructions">
                <h3>Upload CSV with All Stores</h3>
                <p>Upload the <code>complete_year_all_stores.csv</code> file</p>
                <p>Format: <code>date,store_code,sales</code></p>
                <p>This will upload data for all 28 stores at once</p>
            </div>
            
            <input type="file" id="csvFile" accept=".csv" onchange="previewCSV()">
            
            <div id="csvPreview"></div>
            
            <div class="progress" id="uploadProgress">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            
            <button onclick="uploadCSV()" id="csvUploadBtn" disabled style="margin-top: 16px;">üì§ Upload All Sales Data</button>
            <div class="success" id="csvSuccess"></div>
            <div class="error" id="csvError"></div>
        </div>
        
        <!-- Store Settings Section -->
        <div class="section">
            <h2>‚öôÔ∏è Individual Store Settings</h2>
            <div class="instructions">
                <h3>Configure Each Store</h3>
                <p>Set labor budget % and closing hour for each store individually</p>
            </div>
            
            <div id="storeSettingsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin-top: 20px;">
                <!-- Stores will be added here by JavaScript -->
            </div>
            
            <button onclick="saveAllStoreSettings()" style="margin-top: 20px;">üíæ Save All Store Settings</button>
            <div class="success" id="storeSuccess">‚úì All store settings saved!</div>
            <div class="error" id="storeError"></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCg6sdwxr788HymNLHF3skIro7P6SWrvHE",
            authDomain: "labor-tracker-bbbaa.firebaseapp.com",
            projectId: "labor-tracker-bbbaa",
            storageBucket: "labor-tracker-bbbaa.firebasestorage.app",
            messagingSenderId: "939951401620",
            appId: "1:939951401620:web:f2cd20c38c8e36a5466281"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const storeNames = {
            '2166': 'Carson',
            '2493': 'Westport Village', 
            '2029': 'Schuster',
            '2632': 'S 4th Street',
            '2713': 'U OF L',
            '2753': 'Blankenbaker',
            '2888': 'Elizabethtown',
            '2937': 'Jefferson Commons',
            '2098': 'Summit',
            '2131': 'Charlestown',
            '2431': 'Poplar Level',
            '2641': 'Dixie Hwy',
            '2731': 'Veterans',
            '2880': 'Wesley Commons',
            '3044': 'Jeffersonville IN',
            '2274': 'Hurstborne',
            '2546': 'Preston',
            '2811': 'Middletown',
            '2837': 'Harley Center',
            '2086': 'Euclid',
            '2114': 'Frankfort',
            '2294': 'Sir Barton',
            '2521': 'Tiverton',
            '2444': 'Richmond',
            '2524': 'Palomar',
            '2842': 'Georgetown',
            '3286': 'Danville'
        };
        
        const allStores = Object.keys(storeNames);
        
        // Create individual store setting cards
        function initializeStoreSettings() {
            const grid = document.getElementById('storeSettingsGrid');
            
            allStores.forEach(code => {
                const card = document.createElement('div');
                card.style.padding = '16px';
                card.style.background = '#f9fafb';
                card.style.borderRadius = '8px';
                card.style.border = '2px solid #e0e0e0';
                
                card.innerHTML = `
                    <div style="font-weight: 700; color: #1e3c72; margin-bottom: 12px; font-size: 16px;">
                        ${storeNames[code]}
                        <span style="color: #666; font-size: 12px; font-weight: 400;">(${code})</span>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Labor Budget %</label>
                        <input type="number" id="budget_${code}" step="0.01" min="0" max="1" value="0.25" 
                               style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Closing Hour (0-23)</label>
                        <input type="number" id="closing_${code}" min="0" max="23" value="22" 
                               style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px;">
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Load existing settings from Firebase
        async function loadExistingSettings() {
            try {
                for (const code of allStores) {
                    // Load budget
                    const budgetQuery = await db.collection('labor_budgets')
                        .where('store_code', '==', code)
                        .get();
                    
                    if (!budgetQuery.empty) {
                        const budget = budgetQuery.docs[0].data().budget_percentage;
                        document.getElementById(`budget_${code}`).value = budget;
                    }
                    
                    // Load closing hour
                    const settingsQuery = await db.collection('store_settings')
                        .where('store_code', '==', code)
                        .get();
                    
                    if (!settingsQuery.empty) {
                        const closingHour = settingsQuery.docs[0].data().closing_hour;
                        document.getElementById(`closing_${code}`).value = closingHour;
                    }
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Save all store settings
        async function saveAllStoreSettings() {
            const storeSuccess = document.getElementById('storeSuccess');
            const storeError = document.getElementById('storeError');
            storeSuccess.classList.remove('show');
            storeError.classList.remove('show');
            
            try {
                for (const code of allStores) {
                    const budget = parseFloat(document.getElementById(`budget_${code}`).value);
                    const closingHour = parseInt(document.getElementById(`closing_${code}`).value);
                    
                    // Save labor budget
                    const budgetQuery = await db.collection('labor_budgets')
                        .where('store_code', '==', code)
                        .get();
                    
                    if (budgetQuery.empty) {
                        await db.collection('labor_budgets').add({
                            store_code: code,
                            budget_percentage: budget
                        });
                    } else {
                        await db.collection('labor_budgets').doc(budgetQuery.docs[0].id).update({
                            budget_percentage: budget
                        });
                    }
                    
                    // Save closing hour
                    const settingsQuery = await db.collection('store_settings')
                        .where('store_code', '==', code)
                        .get();
                    
                    if (settingsQuery.empty) {
                        await db.collection('store_settings').add({
                            store_code: code,
                            closing_hour: closingHour
                        });
                    } else {
                        await db.collection('store_settings').doc(settingsQuery.docs[0].id).update({
                            closing_hour: closingHour
                        });
                    }
                }
                
                storeSuccess.classList.add('show');
                setTimeout(() => storeSuccess.classList.remove('show'), 3000);
            } catch (error) {
                storeError.textContent = `Error: ${error.message}`;
                storeError.classList.add('show');
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initializeStoreSettings();
            loadExistingSettings();
        });
        
        let csvData = [];
        
        function previewCSV() {
            const file = document.getElementById('csvFile').files[0];
            const preview = document.getElementById('csvPreview');
            const uploadBtn = document.getElementById('csvUploadBtn');
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                
                csvData = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length >= 3) {
                        csvData.push({
                            date: cols[0].trim(),
                            store_code: cols[1].trim(),
                            sales: parseFloat(cols[2].trim())
                        });
                    }
                }
                
                // Count unique dates and stores
                const uniqueDates = new Set(csvData.map(r => r.date)).size;
                const uniqueStores = new Set(csvData.map(r => r.store_code)).size;
                
                preview.innerHTML = `
                    <div class="instructions">
                        <h3>‚úì CSV Loaded Successfully</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #1e3c72;">${csvData.length.toLocaleString()}</div>
                                <div style="color: #666; font-size: 12px;">Total Records</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #1e3c72;">${uniqueStores}</div>
                                <div style="color: #666; font-size: 12px;">Stores</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #1e3c72;">${uniqueDates}</div>
                                <div style="color: #666; font-size: 12px;">Days</div>
                            </div>
                        </div>
                        <div class="preview" style="margin-top: 16px;">${csvData.slice(0, 5).map(row => 
                            `${row.date} - Store ${row.store_code}: $${row.sales.toLocaleString()}`
                        ).join('\n')}${csvData.length > 5 ? '\n...' : ''}</div>
                    </div>
                `;
                
                uploadBtn.disabled = false;
            };
            reader.readAsText(file);
        }
        
        async function uploadCSV() {
            const csvSuccess = document.getElementById('csvSuccess');
            const csvError = document.getElementById('csvError');
            const uploadBtn = document.getElementById('csvUploadBtn');
            const progress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            
            csvSuccess.classList.remove('show');
            csvError.classList.remove('show');
            uploadBtn.disabled = true;
            progress.style.display = 'block';
            
            try {
                const batchSize = 100;
                let uploaded = 0;
                
                for (let i = 0; i < csvData.length; i += batchSize) {
                    const batch = db.batch();
                    const chunk = csvData.slice(i, i + batchSize);
                    
                    for (const row of chunk) {
                        // Check if entry exists
                        const existing = await db.collection('last_year_sales')
                            .where('store_code', '==', row.store_code)
                            .where('date', '==', row.date)
                            .get();
                        
                        if (existing.empty) {
                            const docRef = db.collection('last_year_sales').doc();
                            batch.set(docRef, row);
                        } else {
                            const docId = existing.docs[0].id;
                            batch.update(db.collection('last_year_sales').doc(docId), {sales: row.sales});
                        }
                    }
                    
                    await batch.commit();
                    uploaded += chunk.length;
                    
                    const percent = Math.round((uploaded / csvData.length) * 100);
                    progressBar.style.width = percent + '%';
                    progressBar.textContent = percent + '%';
                }
                
                csvSuccess.textContent = `‚úì Successfully uploaded ${csvData.length.toLocaleString()} records!`;
                csvSuccess.classList.add('show');
                uploadBtn.textContent = '‚úì Upload Complete';
                
                setTimeout(() => {
                    progress.style.display = 'none';
                    csvSuccess.classList.remove('show');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'üì§ Upload All Sales Data';
                }, 5000);
            } catch (error) {
                csvError.textContent = `Error: ${error.message}`;
                csvError.classList.add('show');
                progress.style.display = 'none';
                uploadBtn.textContent = 'üì§ Upload All Sales Data';
                uploadBtn.disabled = false;
            }
        }
        
        async function applyBulkSettings() {
            const bulkSuccess = document.getElementById('bulkSuccess');
            const bulkError = document.getElementById('bulkError');
            bulkSuccess.classList.remove('show');
            bulkError.classList.remove('show');
            
            try {
                const budget = parseFloat(document.getElementById('default_budget').value);
                const closingHour = parseInt(document.getElementById('default_closing').value);
                
                for (const storeCode of allStores) {
                    // Set labor budget
                    const budgetQuery = await db.collection('labor_budgets')
                        .where('store_code', '==', storeCode)
                        .get();
                    
                    if (budgetQuery.empty) {
                        await db.collection('labor_budgets').add({
                            store_code: storeCode,
                            budget_percentage: budget
                        });
                    } else {
                        await db.collection('labor_budgets').doc(budgetQuery.docs[0].id).update({
                            budget_percentage: budget
                        });
                    }
                    
                    // Set closing hour
                    const settingsQuery = await db.collection('store_settings')
                        .where('store_code', '==', storeCode)
                        .get();
                    
                    if (settingsQuery.empty) {
                        await db.collection('store_settings').add({
                            store_code: storeCode,
                            closing_hour: closingHour
                        });
                    } else {
                        await db.collection('store_settings').doc(settingsQuery.docs[0].id).update({
                            closing_hour: closingHour
                        });
                    }
                }
                
                bulkSuccess.classList.add('show');
                setTimeout(() => bulkSuccess.classList.remove('show'), 3000);
            } catch (error) {
                bulkError.textContent = `Error: ${error.message}`;
                bulkError.classList.add('show');
            }
        }
    </script>
</body>
</html>
